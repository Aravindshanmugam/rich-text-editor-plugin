<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="./quill.snow.css" />
    <style>
      html,
      body,
      div,
      span {
        margin: 0;
        padding: 0;
        border: 0;
      }
      #parent-container {
        height: 350px;
        margin: 0px auto;
        display: flex;
        flex-direction: column;
      }
      #quill-container {
        flex: 1;
        border: 1px solid #ccc;
        overflow-y: auto;
      }
      #sizeBar {
        display: block;
        width: 100%;
        background-color: silver;
        height: 15px;
        max-height: 15px;
      }
      #usageMessage {
        position: absolute;
        color: white;
        font-family: sans-serif;
        font-size: 0.7em;
        padding: 0 0 0 2px;
      }
      #usageBar {
        width: 0%;
        height: 100%;
        padding: 0;
      }
      .ql-disabled {
        border: 0px !important;
      }
      .ql-disabled > .ql-editor {
        padding: 0;
      }
      .ql-snow .ql-picker.ql-header.ql-wider {
        width: 110px;
      }
      .ql-toolbar.ql-snow .ql-spacer {
        margin-right: 15px;
      }
      [tooltip] {
        position: relative;
      }
      [tooltip]::after {
        display: none;
        content: attr(tooltip);
        position: absolute;
        left: 50%;
        top: 100%;
        margin-top: 2px;
        transform: translateX(-50%) translateY(0%);
        background: rgba(0, 0, 0, 0.8);
        text-align: center;
        color: #fff;
        padding: 4px 4px;
        font-family: "Appian Open Sans", arial, sans-serif;
        font-size: 12px;
        white-space:nowrap;
        width: "auto";
        pointer-events: none;
        z-index: 1;
      }
      [tooltip]:hover::before,
      [tooltip]:hover::after {
        display: block;
      }
    </style>
    <!-- DO NOT EDIT THE FOLLOWING LINE-->
    <script src="APPIAN_JS_SDK_URI"></script>
  </head>
  <body>
    <div id="parent-container">
      <div id="quill-toolbar">
        <span>
          <select class="ql-header ql-wider" tooltip="Style">
            <option class="ql-header" value="1"></option>
            <option class="ql-header" value="2"></option>
            <option class="ql-header" value="3"></option>
            <option class="ql-header" value="4"></option>
            <option class="ql-header" value="5"></option>
            <option selected>Normal Text</option>
          </select>
          <select class="ql-font" tooltip="Font"></select>
          <select class="ql-size" tooltip="Size">
            <option class="ql-size" value="small"></option>
            <option selected>Standard</option>
            <option class="ql-size" value="large"></option>
            <option class="ql-size" value="huge"></option>
          </select>
        </span>
        <span>
          <button class="ql-bold" tooltip="Bold (%+B)"></button>
          <button class="ql-italic" tooltip="Italic (%+I)"></button>
          <button class="ql-underline" tooltip="Underline (%+U)"></button>
          <button class="ql-strike" tooltip="Strikethrough"></button>
          <button class="ql-script" value="sub" tooltip="Subscript"></button>
          <button class="ql-script" value="super" tooltip="Superscript"></button>
          <select class="ql-color" tooltip="Font Color"></select>
          <select class="ql-background" tooltip="Background Color"></select>
        </span>
        <span>
          <button class="ql-link" tooltip="Add Link (%+K)"></button>
        </span>
        <span>
          <select class="ql-align" tooltip="Alignment"></select>
          <button class="ql-indent" value="-1" tooltip="Unindent (Shift+Tab)"></button>
          <button class="ql-indent" value="+1" tooltip="Indent (Tab)"></button>
        </span>
        <span>
          <button class="ql-list" value="ordered" tooltip="Numbered List"></button>
          <button class="ql-list" value="bullet" tooltip="Bulleted List"></button>
        </span>
        <span>
          <button class="ql-blockquote" tooltip="Blockquote"></button>
          <button class="ql-code" tooltip="Code Style"></button>
        </span>
        <span>
          <button class="ql-clean" tooltip="Remove Formatting"></button>
        </span>
      </div>
      <div id="quill-container"></div>
      <div id="sizeBar">
        <div id="usageMessage"></div>
        <div id="usageBar"></div>
      </div>
    </div>

    <script src="./quill.min.js"></script>
    <script src="./lz-string.min.js"></script>

    <script>
      const MAX_SIZE_DEFAULT = 10000;
      const IS_MAC = navigator.platform.indexOf("Mac") > -1;
      window.quillMaxSize = MAX_SIZE_DEFAULT;
      window.isQuillActive = false;
      window.useCompression = false;
      // Exclude image from supported formats
      // Won't be able to paste unsupported formats
      // Note this is separate from what toolbar allows
      // https://quilljs.com/docs/formats/
      const availableFormats = [
        ["header", "font", "size"],
        ["bold", "italic", "underline", "strike", "script", "color", "background"],
        ["link"],
        ["align", "indent"],
        ["list"],
        ["blockquote", "code"]
      ];
      const availableFormatsFlattened = availableFormats.reduce((acc, val) => acc.concat(val), []);
      /* No longer used, quill-toolbar HTML above is used instead */
      const toolbarOptions = [
        [{ header: [1, 2, 3, 4, 5, 6, false] }, { font: [] }],
        [
          "bold",
          "italic",
          "underline",
          "strike",
          { script: "sub" },
          { script: "super" },
          { color: [] },
          { background: [] }
        ],
        [{ size: ["small", false, "large", "huge"] }], // custom dropdown
        [{ list: "ordered" }, { list: "bullet" }],
        ["link"],
        [{ align: [] }],
        [{ indent: "-1" }, { indent: "+1" }], // outdent/indent
        ["blockquote", "code-block"],
        ["clean"] // clear formatting button
      ];
      var parentContainer = document.getElementById("parent-container");
      var quillContainer = document.getElementById("quill-container");
      var quill;
      var currentValidations = [];

      Appian.Component.onNewValue(function(allParameters) {
        const maxSize = allParameters.maxSize;
        const richText = allParameters.richText;
        const isReadOnly = allParameters.readOnly;
        const enableProgressBar = allParameters.enableProgressBar;
        const height = allParameters.height;
        const placeholder = allParameters.placeholder;

        /* Initialize Quill and set allowed formats and toolbar */
        if (!quill) {
          var allowedFormats = (!allParameters.allowedFormats || !allParameters.allowedFormats.length) ? availableFormatsFlattened : allParameters.allowedFormats;
          quill = new Quill(quillContainer, {
            formats: allowedFormats,
            modules: {
              toolbar: "#quill-toolbar"
            },
            placeholder: "",
            theme: "snow"
          });
          
          /* Hide/show toolbar options based on if they are allowed formats */
          availableFormatsFlattened.forEach(format => {
            Array.from(document.querySelectorAll(buildCssSelector(format))).forEach(element => {
              element.style.display = allowedFormats.includes(format) ? "block" : "none";
            });
          });

          /* Add spacing to the toolbar based on visibilities */
          availableFormats.forEach(formatList => {
            var cssSelectors = [];
            formatList.forEach(format => {
              if (allowedFormats.includes(format)) {
                cssSelectors.push(buildCssSelector(format));
              }
            });
            if (cssSelectors.length > 0) {
              var elementsOfFormatList = document.querySelectorAll(cssSelectors.join(","));
              var lastElementOfFormatList = elementsOfFormatList[elementsOfFormatList.length - 1];
              lastElementOfFormatList.classList.add("ql-spacer");
            }
          });
          
          /* Update tooltips for Mac vs. PC */
          document.querySelectorAll("[tooltip]").forEach(element => {
            element.setAttribute("tooltip", element.getAttribute("tooltip").replace("%", IS_MAC ? "Cmd" : "Ctrl"));
          });

          quill.on("text-change", function(delta, oldDelta, source) {
            if (source == "user") {
              window.isQuillActive = true;
              validate();
            }
          });

          /* only update when focus is lost (when relatedTarget == null) */
          quill.root.addEventListener("blur", function(focusEvent) {
            // See https://github.com/quilljs/quill/issues/1951#issuecomment-408990849
            if (focusEvent && !focusEvent.relatedTarget) {
              window.isQuillActive = false;
              updateValue();
            }
          });
        }

        /* Update maxSize if specified */
        window.quillMaxSize = maxSize || MAX_SIZE_DEFAULT;

        /* Update compression if specified */
        window.useCompression = allParameters.useCompression || false;

        /* Apply display settings */
        handleDisplay(isReadOnly, enableProgressBar, height, placeholder);

        /* update value if user isn't currently editing */
        if (window.isQuillActive) {
          console.warn("Not updating contents because quill is active");
        } else {
          if (window.useCompression) {
            try {
              const contents = getContentsFromCompressed(richText);
              if (contents) {
                quill.setContents(contents);
              } else {
                throw "Not compressed rich text value";
              }
            } catch (error) {
              console.warn("Error parsing compressed data", error);
              quill.setText(richText);
            }
          } else {
            const contents = getContentsFromHTML(richText);
            quill.setContents(contents);
          }
        }

        /* Check max size */
        validate();
      });

      function updateValue() {
        if (validate()) {
          const contents = quill.getContents();
          /* Save value (Quill always adds single newline at end, so treat that as null) */
          if (quill.getText() === "\n") {
            Appian.Component.saveValue("richText", null);
          } else {
            if (window.useCompression) {
              const compressed = compressContents(contents);
              Appian.Component.saveValue("richText", compressed);
            } else {
              const html = getHTMLFromContents(contents);
              Appian.Component.saveValue("richText", html);
            }
          }
        }
      }

      /************ Utility Methods *************/
      function handleDisplay(isReadOnly, enableProgressBar, height, placeholder) {
        quill.enable(!isReadOnly);
        /* Toolbar */
        var toolbar = document.querySelector(".ql-toolbar");
        toolbar.style.display = isReadOnly ? "none" : "block";
        /* Progress Bar */
        var progressBar = document.getElementById("sizeBar");
        progressBar.style.display = (enableProgressBar === false || isReadOnly) ? "none" : "block";
        /* Height */
        parentContainer.style.height = isReadOnly ? height : (height === "auto" ? "350px": height);
        /* Placeholder */
        quill.root.dataset.placeholder = (placeholder && !isReadOnly) ? placeholder : "";
      }

      function compressContents(contents) {
        const stringified = JSON.stringify(contents);
        const compressed = LZString.compressToBase64(stringified);
        return compressed;
      }

      function getContentsFromCompressed(compressed) {
        const decompressed = LZString.decompressFromBase64(compressed);
        const richTextContents = JSON.parse(decompressed);
        return richTextContents;
      }

      function getContentsFromHTML(html) {
        var richTextContents = quill.clipboard.convert(html);
        /* compensate for bug in Quill where it keeps adding newlines before block elements when converting from HTML */
        richTextContents.ops.forEach(element => {
          var text = element.insert;
          if (typeof text === "string" && text.endsWith("\n\n")) {
            const endingBreaksIndex = text.lastIndexOf("\n\n");
            if (endingBreaksIndex >= 0) {
              text = text.substring(0, endingBreaksIndex) + "\n";
              element.insert = text;
            }
          }
        });
        return richTextContents;
      }

      function getHTMLFromContents(contents) {
        var tempQuill = new Quill(document.createElement("div"));
        tempQuill.setContents(contents);
        return tempQuill.root.innerHTML;
      }

      /**
       * Enforce validations (currently just size validation)
       * @return {boolean} Whether the component is valid
       */
      function validate() {
        const size = getSize(window.useCompression);
        updateUsageBar(size);
        var newValidations = [];
        if (size > window.quillMaxSize) {
          newValidations.push("Content exceeds maximum allowed size");
        }
        if (!(newValidations.toString() === currentValidations.toString())) Appian.Component.setValidations(newValidations);
        currentValidations = newValidations;
        return currentValidations.length === 0;
      }

      function getSize(useCompression) {
        if (quill.getText() === "\n") {
          return 0;
        }
        const contents = quill.getContents();
        if (useCompression) {
          const compressed = compressContents(contents);
          return compressed.length;
        } else {
          const html = getHTMLFromContents(contents);
          return html.length;
        }
      }

      function updateUsageBar(size) {
        var usageBar = document.getElementById("usageBar");
        var usageMessage = document.getElementById("usageMessage");
        const usage = Math.round((100 * size) / window.quillMaxSize);
        const usagePercent = usage <= 100 ? usage + "%" : "100%";
        /* update usage message */
        const message = " " + usagePercent + " used";
        usageMessage.innerHTML = message;
        /* update usage bar width and color */
        usageBar.style.width = usagePercent;
        if (usage <= 75) {
          usageBar.style.backgroundColor = Appian.getAccentColor();
        } else if (usage <= 90) {
          usageBar.style.backgroundColor = "orange";
        } else {
          usageBar.style.backgroundColor = "red";
        }
      }

      function buildCssSelector(format) {
        return "button.ql-" + format + ",span.ql-" + format;
      }
    </script>
  </body>
</html>
